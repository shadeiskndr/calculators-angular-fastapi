<div class="flex flex-col gap-4">
  <!-- Add Dataset Section -->
  <div class="flex gap-2">
    <p-button
      label="Add Dataset"
      icon="pi pi-plus"
      (onClick)="addDataset()"
      [disabled]="datasets.length >= 10"
    />
    <p-button
      label="Calculate All"
      icon="pi pi-calculator"
      (onClick)="calculateBatchVaR()"
      [loading]="loading"
      [disabled]="!hasValidDatasets()"
      severity="success"
    />
    <p-button
      label="Clear All"
      icon="pi pi-trash"
      (onClick)="clearAll()"
      severity="danger"
      outlined
    />
  </div>

  <!-- Datasets Table -->
  <p-table [value]="datasets" styleClass="p-datatable-sm">
    <ng-template pTemplate="header">
      <tr>
        <th>Name</th>
        <th>Data</th>
        <th>Confidence</th>
        <th>Method</th>
        <th>Valid</th>
        <th>Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-dataset let-i="rowIndex">
      <tr>
        <td>
          <input
            pInputText
            [(ngModel)]="dataset.name"
            class="w-full"
            placeholder="Dataset name"
          />
        </td>
        <td>
          <textarea
            pInputText
            [(ngModel)]="dataset.numbersInput"
            (ngModelChange)="validateDataset(dataset)"
            rows="2"
            class="w-full resize-none"
            placeholder="1,2,3,4,5..."
          ></textarea>
        </td>
        <td>
          <p-inputNumber
            [(ngModel)]="dataset.confidenceLevel"
            (ngModelChange)="validateDataset(dataset)"
            [min]="80"
            [max]="99.99"
            suffix="%"
            styleClass="w-full"
          />
        </td>
        <td>
          <p-dropdown
            [(ngModel)]="dataset.method"
            [options]="methodOptions"
            optionLabel="label"
            optionValue="value"
            styleClass="w-full"
          />
        </td>
        <td>
          <i
            class="pi"
            [ngClass]="{
              'pi-check text-green-500': dataset.isValid,
              'pi-times text-red-500': !dataset.isValid
            }"
          ></i>
        </td>
        <td>
          <p-button
            icon="pi pi-trash"
            (onClick)="removeDataset(i)"
            severity="danger"
            text
            size="small"
          />
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Results Section -->
  <div *ngIf="results.length > 0" class="mt-4">
    <h3 class="text-lg font-semibold mb-3">Batch Results</h3>
    <p-table [value]="results" styleClass="p-datatable-sm">
      <ng-template pTemplate="header">
        <tr>
          <th>Dataset</th>
          <th>Status</th>
          <th>VaR</th>
          <th>Confidence</th>
          <th>Method</th>
          <th>Sample Size</th>
          <th>Error</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-result>
        <tr>
          <td>{{ getDatasetName(result.dataset_index) }}</td>
          <td>
            <span
              class="px-2 py-1 rounded text-xs"
              [ngClass]="{
                'bg-green-100 text-green-800': result.status === 'success',
                'bg-red-100 text-red-800': result.status === 'failed'
              }"
            >
              {{ result.status }}
            </span>
          </td>
          <td>{{ result.result?.var | number : "1.4-4" }}</td>
          <td>{{ result.result?.confidence_level }}</td>
          <td>{{ result.result?.method }}</td>
          <td>{{ result.result?.sample_size }}</td>
          <td>
            <span *ngIf="result.error" class="text-red-600 text-xs">
              {{ result.error }}
            </span>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Error Display -->
  <p-message
    *ngIf="error"
    severity="error"
    [text]="error"
    styleClass="w-full"
  />
</div>
